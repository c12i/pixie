(()=>{"use strict";function t(t,e,...o){let i=document.createElement(t);e&&Object.assign(i,e);for(let t of o)"string"!=typeof t?i.appendChild(t):i.appendChild(document.createTextNode(t));return i}function e(t){return t.toString(16).padStart(2,"0")}class o{constructor(t,e,o){this.width=t,this.height=e,this.pixels=o}static empty(t,e,i){let n=new Array(t*e).fill(i);return new o(t,e,n)}pixel(t,e){return this.pixels[t+e*this.width]}draw(t){let e=this.pixels.slice();for(let{x:o,y:i,color:n}of t)e[o+i*this.width]=n;return new o(this.width,this.height,e)}}function i(t,e,o){e.width=t.width*o,e.height=t.height*o;let i=e.getContext("2d");for(let e=0;e<t.height;e++)for(let n=0;n<t.width;n++)i.fillStyle=t.pixel(n,e),i.fillRect(n*o,e*o,o,o)}class n{constructor(e,o){this.dom=t("canvas",{onmousedown:t=>this.mouse(t,o),ontouchstart:t=>this.touch(t,o)}),this.syncState(e)}syncState(t){this.picture!=t&&(this.picture=t,i(this.picture,this.dom,10))}}function s(t,e){let o=e.getBoundingClientRect();return{x:Math.floor((t.clientX-o.left)/10),y:Math.floor((t.clientY-o.top)/10)}}n.prototype.mouse=function(t,e){if(0!=t.button)return;let o=s(t,this.dom),i=e(o);if(!i)return;let n=t=>{if(0==t.buttons)this.dom.removeEventListener("mousemove",n);else{let e=s(t,this.dom);if(e.x==o.x&&e.y==o.y)return;i(e)}};this.dom.addEventListener("mousemove",n)},n.prototype.touch=function(t,e){let o=s(t.touches[0],this.dom),i=e(o);if(t.preventDefault(),!i)return;let n=t=>{let e=s(t.touches[0],this.dom);e.x==o.x&&e.y==o.y||(o=e,i(e))};this.dom.addEventListener("touchmove",n),this.dom.addEventListener("touchend",(()=>{this.dom.removeEventListener("touchmove",n),this.dom.removeEventListener("touchend",n)}))};class c{constructor(e,o){let{tools:i,controls:s,dispatch:c}=o;this.state=e,this.canvas=new n(e.picture,(t=>{let e=(0,i[this.state.tool])(t,this.state,c);if(e)return t=>e(t,this.state)})),this.controls=s.map((t=>new t(e,o))),this.dom=t("div",{},this.canvas.dom,t("br"),...this.controls.reduce(((t,e)=>t.concat(" ",e.dom)),[]))}syncState(t){this.state=t,this.canvas.syncState(t.picture);for(let e of this.controls)e.syncState(t)}}const l=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];function r(i){let n=Math.min(100,i.width),s=Math.min(100,i.height),c=t("canvas",{width:n,height:s}).getContext("2d");c.drawImage(i,0,0);let l=[],{data:r}=c.getImageData(0,0,n,s);for(let t=0;t<r.length;t+=4){let[o,i,n]=r.slice(t,t+3);l.push(`#${e(o)}${e(i)}${e(n)}`)}return new o(n,s,l)}const h={tool:"draw",color:"#000000",picture:o.empty(60,30,"#f0f0f0"),done:[],doneAt:0},d={draw:function(t,e,o){function i({x:t,y:e},i){let n={x:t,y:e,color:i.color};o({picture:i.picture.draw([n])})}return i(t,e),i},fill:function({x:t,y:e},o,i){let n=o.picture.pixel(t,e),s=[{x:t,y:e,color:o.color}];for(let t=0;t<s.length;t++)for(let{dx:e,dy:i}of l){let c=s[t].x+e,l=s[t].y+i;c>=0&&c<o.picture.width&&l>=0&&l<o.picture.height&&o.picture.pixel(c,l)==n&&!s.some((t=>t.x==c&&t.y==l))&&s.push({x:c,y:l,color:o.color})}i({picture:o.picture.draw(s)})},rectangle:function(t,e,o){function i(i){let n=Math.min(t.x,i.x),s=Math.min(t.y,i.y),c=Math.max(t.x,i.x),l=Math.max(t.y,i.y),r=[];for(let t=s;t<=l;t++)for(let o=n;o<=c;o++)r.push({x:o,y:t,color:e.color});o({picture:e.picture.draw(r)})}return i(t),i},pick:function(t,e,o){o({color:e.picture.pixel(t.x,t.y)})}},a=[class{constructor(e,{tools:o,dispatch:i}){this.select=t("select",{onchange:()=>i({tool:this.select.value})},...Object.keys(o).map((o=>t("option",{selected:o==e.tool},o)))),this.dom=t("label",null,"Tool: ",this.select)}syncState(t){this.select.value=t.tool}},class{constructor(e,{dispatch:o}){this.input=t("input",{type:"color",value:e.color,onchange:()=>o({color:this.input.value})}),this.dom=t("label",null,"🎨 Color: ",this.input)}syncState(t){this.input.value=t.color}},class{constructor(e){this.picture=e.picture,this.dom=t("button",{onclick:()=>this.save()},"💾 Save")}save(){let e=t("canvas");i(this.picture,e,10);let o=t("a",{href:e.toDataURL(),download:"pixel-art.png"});document.body.appendChild(o),o.click(),o.remove()}syncState(t){this.picture=t.picture}},class{constructor(e,{dispatch:o}){this.dom=t("button",{onclick:()=>function(e){let o=t("input",{type:"file",onchange:()=>function(e,o){if(null==e)return;let i=new FileReader;i.addEventListener("load",(()=>{let e=t("img",{onload:()=>o({picture:r(e)}),src:i.result})})),i.readAsDataURL(e)}(o.files[0],e)});document.body.appendChild(o),o.click(),o.remove()}(o)},"📁 Load")}syncState(){}},class{constructor(e,{dispatch:o}){this.dom=t("button",{onclick:()=>o({undo:!0}),disabled:0==e.done.length},"⃔ Undo")}syncState(t){this.dom.disabled=0==t.done.length}}];document.getElementById("root").appendChild(function({state:t=h,tools:e=d,controls:o=a}){const i=new c(t,{tools:e,controls:o,dispatch(e){t=function(t,e){return 1==e.undo?0==t.done.length?t:{...t,picture:t.done[0],done:t.done.slice(1),doneAt:0}:e.picture&&t.doneAt<Date.now()-1e3?{...t,...e,done:[t.picture,...t.done],doneAt:Date.now()}:{...t,...e}}(t,e),i.syncState(t)}});return i.dom}({}))})();